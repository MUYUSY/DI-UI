<div class="row">
    <div class="col-md-12">
        <!-- BEGIN: ACCORDION DEMO -->
        <div class="portlet light">
            <div class="portlet-title">
                <div class="caption font-dark">
                    <span class="caption-subject bold uppercase">调查记录</span>
                </div>
            </div>

            <div class="portlet-body">
                <tabset>
                    <tab heading="所有调查记录">
                        <div class="portlet-body">
                            <div class="col-md-12 col-sm-12 col-xs-12">
                                <button class="btn"
                                        style="width:100px; border:1px solid #cccccc; background-color: #FFFFFF; margin-right:10px">
                                    <img src="./icon/delete.png" style="margin: 0 10px 1px 0">删除
                                </button>
                            </div>
                            <div class="col-md-12 col-sm-12 col-xs-12">
                                <table class="table table-striped table-bordered table-hover endpoint-table"
                                       width="100%"
                                       id="investigation">
                                    <thead>
                                    <tr>
                                        <th width="5%">
                                            <!--<input type="checkbox" id="checkall" onclick="checkAll(this)">-->
                                        </th>
                                        <th width="10%"></th>
                                        <th width="10%"></th>
                                        <th width="75%"></th>
                                        <th></th>
                                    </tr>
                                    </thead>
                                </table>
                            </div>
                        </div>
                    </tab>
                    <tab heading="历史事件树">
                        <div>历史事件树</div>
                    </tab>
                </tabset>
            </div>
        </div>
    </div>
</div>
<script src="../assets/global/plugins/DataTables-1.10.15/media/js/jquery.dataTables.js" type="text/javascript"></script>
<script src="../assets/global/plugins/DataTables-1.10.15/extensions/RowGroup/js/dataTables.rowGroup.js"
        type="text/javascript"></script>
<script src="../assets/global/plugins/DataTables-1.10.15/extensions/Select/js/dataTables.select.js"
        type="text/javascript"></script>
<script>
    var investigationTable;
    var eventtreeTable;

    Date.prototype.format = function (fmt) {
        var o = {
            "M+": this.getMonth() + 1,                 //月份
            "d+": this.getDate(),                    //日
            "h+": this.getHours(),                   //小时
            "m+": this.getMinutes(),                 //分
            "s+": this.getSeconds(),                 //秒
            "q+": Math.floor((this.getMonth() + 3) / 3), //季度
            "S": this.getMilliseconds()             //毫秒
        };
        if (/(y+)/.test(fmt)) {
            fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
        }
        for (var k in o) {
            if (new RegExp("(" + k + ")").test(fmt)) {
                fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
            }
        }
        return fmt;
    };

    var timeStamp2String = function (time, format) {
        if (typeof(time) == "number") {
            time = time.toString();
        }
        if (time.length != 10 && time.length != 13) {
            return time;
        }
        if (time.length == 10) {
            time = time * 1000;
        }
        var datetime = new Date();
        datetime.setTime(time);
        return datetime.format(format);
    };

    var checkGroup = function(obj, table) {
        if (table === 1) {
            dtable = investigationTable;
        }
        else {
            dtable = eventtreeTable;
        }
        var groupName = obj.id;
        if( obj.checked ) {
            for (var i = 0; i < dtable.api().rows().data().length; i++) {
                if (dtable.api().rows().data()[i].group === groupName) {
                    dtable.api().rows(i).select()
                }
            }
        } else {
            for (var k = 0; k < dtable.api().rows().data().length; k++) {
                if (dtable.api().rows().data()[k].group === groupName) {
                    dtable.api().rows(k).deselect()
                }
            }
        }
    };

    $.ajax({
        url: "investigationrecord",
        type: "POST",
        dataType: "json",
        data: JSON.stringify({"action": "get"}),
        success: function (data) {
            // For Investigation Record
            var investigationRecord;
            var investigationTableContent = [];
            if (data.type1) {
                investigationRecord = data.type1;
                for (var i = 0; i < investigationRecord.length; i++) {
                    investigationTableContent.push({
                        group: timeStamp2String(investigationRecord[i].time, "yyyy-MM-dd"),
                        time: timeStamp2String(investigationRecord[i].time, "hh:mm"),
                        user: investigationRecord[i].user,
                        name: {name: investigationRecord[i].name, content: investigationRecord[i].data},
                        content: investigationRecord[i].data,
                        rowid: investigationRecord[i].id,
                        id: ""
                    })
                }
            } else {
                investigationTableContent = [];
            }

            var investigationConfig = {
                data: investigationTableContent,
                order: [[4, "asc"]],
                rowGroup: {
                    startRender: function (rows, group) {
                        return $('<tr/>')
                            .append('<td><input type="checkbox" id="' + group + '" class="check-group" onclick="checkGroup(this, 1)"></td>')
                            .append('<td colspan="6">' + group + '</td>')
                    },
                    dataSrc: "group"
                },
                select: {
                    style: 'multi',
                    selector: 'td:first-child'
                },
                columns: [
                    {
                        orderable: false,
                        bSortable: false,
                        className: 'select-checkbox',
                        data: "id",
                        targets: 0
                    },
                    {data: "time"},
                    {data: "user"},
                    {
                        data: "name",
                        render: function (data) {
                            return "<a target='_blank' href='#/new_investigation?json=" + JSON.stringify(data.content) + "'>" + data.name + "</a>";

                        }
                    },
                    {
                        data: "group",
                        visible: false
                    }
                ],
                rowId: "rowid",
                sPaginationType: "full_numbers",
                ordering: false,
                language: {
                    emptyTable: "没有调查记录",
                    info: "显示 _TOTAL_ 个记录中的第 _START_ 至 _END_ 个",
                    infoEmpty: "没有匹配的调查记录",
                    infoFiltered: "(过滤出 filtered1 个调查记录，总计 _MAX_ 个调查记录)",
                    lengthMenu: "每页 _MENU_ 条调查记录",
                    search: "过滤:",
                    zeroRecords: "没有调查记录",
                    paginate: {
                        last: ">>",
                        next: ">",
                        previous: "<",
                        first: "<<"
                    },
                    select: {
                        rows: {
                            _: "您选择了 %d 个调查记录。",
                            0: "点击选择调查记录!"
                        }
                    }
                },
                displayLength: 20,
                "dom": "<'row'<'col-md-3 col-sm-12'i><'col-md-9 col-sm-12'f>r><t><'row'<'col-md-12 col-sm-12'p>>"
            };

            if (investigationTable != null) {
                investigationTable.fnClearTable();
                investigationTable.fnDestroy();
                $("tbody").remove();
            }

            investigationTable = $('#investigation').dataTable(investigationConfig);
        }
    })


</script>