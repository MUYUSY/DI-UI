<!-- BEGIN MAIN CONTENT -->
<div class="row">
    <div class="col-md-12">
        <!-- BEGIN: ACCORDION DEMO -->
        <div class="portlet light">
            <div class="portlet-title">
                <div class="caption font-green-sharp">
                    <span class="caption-subject bold uppercase">新建调查</span>
                </div>
                <div class="tools">
                    <a href="" class="collapse"> </a>
                    <a href="" class="fullscreen"> </a>
                </div>
            </div>

            <div class="portlet-body" ng-controller="HighLevelToggle">
                <div class="col-md-12 col-sm-12 col-xs-12">
                    <div class="col-md-4 col-sm-12 col-xs-12 searchDatePicker">
                        <input type="text" id="searchDateRange" class="form-control">
                        <i class="fa fa-calendar"></i>
                    </div>
                    <div class="col-md-2 col-sm-12 col-xs-12" ng-dropdown-multiselect
                         options="selectByGroupData"
                         selected-model="selectByGroupModel"
                         extra-settings="selectByGroupSettings"
                         group-by="gender"
                         translation-texts="selectByGroupTexts">
                    </div>
                    <div class="col-md-1 col-sm-12 col-xs-12" style="margin-right: 15px;">
                        <button class="btn" style="width:100px; border:1px solid #cccccc;" ng-click="toggle()">高级
                        </button>
                    </div>
                    <div class="col-md-12 col-sm-12 col-xs-12 high-level" ng-show="myHide">
                        <div class="col-xs-12 condition" ng-controller="NewConditionController">
                            <div class="col-xs-12 search-condition" ng-repeat="id in conditions">
                                <div class="col-xs-2">
                                    <select class="select form-control"
                                            ng-model="id.value" ng-init="id.value = conditionName[0]"
                                            ng-options="x for x in conditionName" ng-change="change(id)">
                                    </select>
                                </div>
                                <div class="col-xs-2" ng-show="id.class1">
                                    <select class="select form-control" ng-model="id.include"
                                            ng-options="x for x in include" ng-init="id.include = include[0]">
                                    </select>
                                </div>
                                <div class="col-xs-2" ng-show="id.class2">
                                    <select class="select form-control" ng-model="id.equal"
                                            ng-options="x for x in equal" ng-init="id.equal = equal[0]">
                                    </select>
                                </div>
                                <div class="col-xs-3" ng-hide="id.class3">
                                    <input type="text" ng-model="id.input"
                                           class="search-input form-control ng-pristine ng-valid ng-touched">
                                </div>
                                <div class="col-xs-2" ng-show="id.class3">
                                    <select class="select form-control"
                                            ng-model="id.father"
                                            ng-init="id.father = protocolFathers[0]"
                                            ng-change="protocolInit(id)"
                                            ng-options="x for x in protocolFathers"></select>
                                </div>
                                <div class="col-xs-2" ng-show="id.class3">
                                    <select class="select form-control"
                                            ng-model="id.child" ng-init="id.child"
                                            ng-options="y for y in protocolChildren[id.father]">
                                    </select>
                                </div>
                                <button ng-show="closeable" type="button" class="close"
                                        ng-click="closeCondition($index)">
                                    <span aria-hidden="true">×</span>
                                    <span class="sr-only">Close</span>
                                </button>
                            </div>
                            <div class="col-xs-2">
                                <button class="add-condition" ng-disabled="maxCondition" ng-click="addCondition()">
                                    +增加条件
                                </button>
                            </div>

                        </div>
                    </div>

                    <div class="col-md-4 col-sm-12 col-xs-12" ng-hide="myHide">
                        <button class="btn" ng-click="search()"
                                style="width: 100px; background-color:#0076e1; color: #ffffff; padding-right: 32px;">
                            <img src="./icon/search.png" style="margin: 0 4px 1px 0;">搜索
                        </button>
                        <button class="btn" style="width:100px; border:1px solid #cccccc">
                            <img src="./icon/save.png" style="margin: 0 4px 1px 0">保存规则
                        </button>
                    </div>
                    <div class="col-md-6 col-sm-12 col-xs-12" ng-show="myHide">
                        <button class="btn" ng-click="search()"
                                style="width: 100px; background-color:#0076e1; color: #ffffff; padding-right: 32px">
                            <img src="./icon/search.png" style="margin: 0 4px 1px 0;">搜索
                        </button>
                        <button class="btn" style="width:100px; border:1px solid #cccccc">
                            <img src="./icon/save.png" style="margin: 0 4px 1px 0">保存规则
                        </button>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12 col-sm-12 col-xs-12">
                    <div class="portlet light">
                        <div class="portlet-title">
                            <div class="caption font-dark col-md-6 col-sm-6 col-xs-12">
                                <span class="caption-subject bold uppercase">调查结果</span>
                            </div>
                            <div class="col-md-6 col-sm-6 col-xs-12">
                                <button class="btn dark btn-outline pull-right" id="exportResult">导出结果</button>
                            </div>
                        </div>
                        <div class="portlet-body">
                            <table class="table table-striped table-bordered table-hover" width="100%"
                                   id="search-result">
                                <thead>
                                <tr>
                                    <th width="5%"></th>
                                    <th width="15%">时间戳</th>
                                    <th width="15%">探针名</th>
                                    <th width="15%">进程用户名</th>
                                    <th width="10%">进程ID</th>
                                    <th width="25%">进程映像路径</th>
                                    <th width="15%">事件类型</th>
                                </tr>
                                </thead>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    ComponentsSelect2.init();
    ComponentsBootstrapSelect.init();
    UITree.init();
    //TableDatatablesResponsive.init();
</script>
<!-- BEGIN MAIN JS -->
<script>
    var dtable;
    $('#exportResult').hide();

    $('.searchDatePicker i').click(function () {
        $(this).parent().find('input').click();
    });

    $('#searchDateRange').daterangepicker({
        "timePicker": true,
        "timePicker24Hour": true,
        "maxDate" : moment(),
        "ranges": {
            "今天": [moment().startOf('day'), moment()],
            "昨天": [moment().subtract('days', 1).startOf('day'), moment().subtract('days', 1).endOf('day')],
            "过去7天": [moment().subtract('days', 6), moment()],
            "本周": [moment().startOf('week'), moment()],
            "过去30天": [moment().subtract('days', 29), moment()],
            "本月": [moment().startOf('month'), moment()]
        },
        "locale": {
            "format": "YYYY/MM/DD hh:mm",
            "separator": " 至 ",
            "applyLabel": "应用",
            "cancelLabel": "取消",
            "fromLabel": "从",
            "toLabel": "至",
            "customRangeLabel": "自定义",
            "weekLabel": "周",
            "daysOfWeek": [
                "日",
                "一",
                "二",
                "三",
                "四",
                "五",
                "六"
            ],
            "monthNames": [
                "一月",
                "二月",
                "三月",
                "四月",
                "五月",
                "六月",
                "七月",
                "八月",
                "九月",
                "十月",
                "十一月",
                "十二月"
            ],
            "firstDay": 1
        },
        "startDate": moment().startOf('day'),
        "endDate": moment()
    }, function (start, end, label) {
        console.log("New date range selected: " + start + ' to ' + end.format('YYYY-MM-DD  hh:mm') + ' (predefined range: ' + label + ')');
    });

    function HighLevelToggle($scope) {
        $scope.myHide = false;
        $scope.toggle = function () {
            $scope.myHide = !$scope.myHide;
        };
        $scope.conditions = [
            {
                key: 1,
                value: "test1",
                class1: true,
                class2: false,
                class3: false,
                input: "",
                father: "分类一",
                child: "HTTP",
                include: "包含",
                equal: "等于"
            }
        ];
        $scope.selectByGroupModel = [];
        $scope.selectByGroupData = [
            {id: 1, label: "David", gender: 'M'},
            {id: 2, label: "Jhon", gender: 'M'},
            {id: 3, label: "Lisa", gender: 'F'},
            {id: 4, label: "Nicole", gender: 'F'},
            {id: 5, label: "Danny1", gender: 'M'},
            {id: 6, label: "Danny2", gender: 'M'},
            {id: 7, label: "Danny3", gender: 'M'},
            {id: 8, label: "Danny4", gender: 'M'},
            {id: 9, label: "Danny5", gender: 'M'},
            {id: 10, label: "Danny6", gender: 'M'},
            {id: 11, label: "Danny7", gender: 'M'},
            {id: 12, label: "Danny8", gender: 'M'},
            {id: 13, label: "Danny9", gender: 'M'},
            {id: 14, label: "Danny10", gender: 'M'},
            {id: 15, label: "Danny11", gender: 'M'},
            {id: 16, label: "Danny12", gender: 'M'},
            {id: 17, label: "Danny13", gender: 'M'},
            {id: 18, label: "Danny14", gender: 'M'},
            {id: 19, label: "Danny15", gender: 'M'},
            {id: 20, label: "Danny16", gender: 'M'},
            {id: 21, label: "Danny17", gender: 'M'},
            {id: 22, label: "Danny18", gender: 'M'},
            {id: 23, label: "Danny19", gender: 'M'},
            {id: 24, label: "Danny20", gender: 'M'},
            {id: 25, label: "Danny21", gender: 'M'},
            {id: 26, label: "Danny22", gender: 'M'},
            {id: 27, label: "Danny23", gender: 'M'},
            {id: 28, label: "Danny24", gender: 'M'},
            {id: 29, label: "Danny25", gender: 'M'},
            {id: 30, label: "Danny26", gender: 'M'},
            {id: 31, label: "Danny27", gender: 'M'},
            {id: 32, label: "Danny28", gender: 'M'},
            {id: 33, label: "Danny29", gender: 'M'},
            {id: 34, label: "Danny30", gender: 'M'},
            {id: 35, label: "Danny31", gender: 'M'},
            {id: 36, label: "Danny32", gender: 'M'},
            {id: 37, label: "Danny33", gender: 'M'},
            {id: 38, label: "Danny34", gender: 'M'},
            {id: 39, label: "Danny35", gender: 'M'},
            {id: 40, label: "Danny36", gender: 'M'},
            {id: 41, label: "Danny37", gender: 'M'},
            {id: 42, label: "Danny38", gender: 'M'},
            {id: 43, label: "Danny39", gender: 'M'},
            {id: 44, label: "Danny40", gender: 'M'},
            {id: 45, label: "Unknown", gender: 'O'}];

        $scope.selectByGroupSettings = {
            selectByGroups: ['F', 'M'],
            groupByTextProvider: function (groupValue) {
                switch (groupValue) {
                    case 'M':
                        return 'Male';
                    case 'F':
                        return 'Female';
                    case 'O':
                        return 'Other';
                }
            },
            scrollableHeight: '400px',
            scrollable: true,
            enableSearch: true
        };

        $scope.selectByGroupTexts = {
            buttonDefaultText: "所有探针设备...",
            selectGroup: '选择所有:',
            allSelectedText: '全部',
            searchPlaceholder: '检索...',
            checkAll: '选择所有',
            uncheckAll: '取消所有选择',
            selectionCount: '被选中'
        }

        $scope.search = function () {
            $scope.search_condition = [];
            for (var i = 0; i < $scope.conditions.length; i++) {
                if ($scope.conditions[i].value == "网络协议名") {
                    $scope.search_condition.push({key: $scope.conditions[i].value, input: $scope.conditions[i].child});
                }
                else {
                    $scope.search_condition.push({key: $scope.conditions[i].value, input: $scope.conditions[i].input});
                }
            }
            SearchResultCtrl($scope.search_condition);
            $scope.myHide = false;
        }
    }

    var getValue = function (item) {
        return item.split("=")[1];
    };

    var highlightStr = function (str, keyword) {
        if (keyword == "") {
            return str
        }
        else {
            list = str.split(keyword);
            var result = list[0];
            for (var i = 1; i < list.length; i++) {
                result += '<mark>';
                result += keyword;
                result += '</mark>';
                result += list[i];
            }
            return result;
        }
    };

    var formatData = function (item, condition) {
        var list = item.split('\t');
        var result = "";
        for (var i = 0; i < list.length; i++) {
            for (var j = 0; j < condition.length; j++) {
                result += ' | ';
                result += '<b>';
                result += list[i].split("=")[0];
                result += '</b>';
                result += ':';
                result += highlightStr(list[i].substring(list[i].indexOf("=") + 1), condition[j].input);
            }
        }
        return result.substring(2);
    };

    var format = function (obj) {
        return '<tr>' + '<td>' + obj + '</td>' + '</tr>';
    };

    var SearchResultCtrl = function (search_condition) {
        $.getJSON('./views/data1W.js', function (data) {
            var results = [];
            for (var i = 0; i < data.length; i++) {
                results.push({
                    timestamp: getValue(data[i].key[0]),
                    deviceName: getValue(data[i].key[1]),
                    processUsername: getValue(data[i].key[2]),
                    processId: getValue(data[i].key[3]),
                    processPath: getValue(data[i].key[4]),
                    eventType: getValue(data[i].key[5]),
                    content: formatData(data[i].data, search_condition)
                })
            }
            var config = {
                data: results,
                columns: [
                    {
                        "class": 'details-control',
                        "orderable": false,
                        "data": null,
                        "defaultContent": ''
                    },
                    {data: "timestamp"},
                    {data: "deviceName"},
                    {data: "processUsername"},
                    {data: "processId"},
                    {data: "processPath"},
                    {data: "eventType"}],
                order: [],
                sPaginationType: "full_numbers",
                language: {
                    aria: {
                        sortAscending: ": activate to sort column ascending",
                        sortDescending: ": activate to sort column descending"
                    },
                    emptyTable: "无匹配的数据可显示",
                    info: "显示 _TOTAL_ 条目中的第 _START_ 至 _END_ 条",
                    infoEmpty: "没有匹配的条目",
                    infoFiltered: "(过滤出 filtered1 条目，总计 _MAX_ 条目)",
                    lengthMenu: "_MENU_ 项",
                    search: "搜索:",
                    zeroRecords: "无匹配的数据可显示"
                },
                lengthMenu: [
                    [20, 50, 100, -1],
                    [20, 50, 100, "全部"] // change per page values here
                ],
                "dom": "<'row' <'col-md-12'B>><'row'<'col-md-6 col-sm-12'l><'col-md-6 col-sm-12'f>r><t><'row'<'col-md-5 col-sm-12'i><'col-md-7 col-sm-12'p>>"
            };

            if (dtable != null) {
                dtable.fnClearTable();
                dtable.fnDestroy();
                $("tbody").remove();
            }

            dtable = $('#search-result').dataTable(config);
            $("tbody").on('click', 'td.details-control', function () {
                var tr = $(this).closest('tr');
                var row = dtable.api().row(tr);
                if (row.child.isShown()) {
                    // This row is already open - close it
                    row.child.hide();
                    tr.removeClass('shown');
                }
                else {
                    console.log(row.data().content);
                    row.child(format((row.data().content))).show();
                    tr.addClass('shown');
                }
            })

            if (dtable == null) {
                $('#exportResult').hide();
            }
            else {
                $('#exportResult').show();
            }
        })
    };

    function NewConditionController($scope) {
        $scope.conditionName = ["进程用户名", "进程ID", "进程名", "IP地址", "网络协议名", "Url", "文件名"];
        $scope.protocolFathers = ["分类一", "分类二"];
        $scope.protocolChildren = {
            "分类一": ["HTTP", "HTTPS"],
            "分类二": ["FTP", "SSH"]
        };
        $scope.include = ["包含", "不包含"];
        $scope.equal = ["等于", "不等于"];
        $scope.change = function (item) {
            if (item.value == "网络协议名") {
                item.class1 = false;
                item.class2 = false;
                item.class3 = true;
            }
            else if (item.value == "进程ID" || item.value == "IP地址") {
                item.class1 = false;
                item.class2 = true;
                item.class3 = false;
            }
            else {
                item.class1 = true;
                item.class2 = false;
                item.class3 = false;
            }
        };

        $scope.protocolInit = function (item) {
            item.child = $scope.protocolChildren[item.father][0];
        };
        $scope.index = 2;
        $scope.maxCondition = false;
        $scope.closeable = false;
        $scope.addCondition = function () {
            $scope.conditions.push(
                {key: $scope.index, value: "test2", class1: true, class2: false, class3: false}
            );
            $scope.index += 1;
            $scope.closeable = true;
            if ($scope.conditions.length == 7) {
                $scope.maxCondition = true;
            }
        };
        $scope.closeCondition = function (index) {
            $scope.conditions.splice(index, 1);
            if ($scope.conditions.length == 1) {
                $scope.closeable = false;
            }
            $scope.maxCondition = false;
        };
    }

</script>
<!-- END MAIN JS -->