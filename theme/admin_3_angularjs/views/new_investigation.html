<!-- BEGIN MAIN CONTENT -->
<div class="row">
    <div class="col-md-12">
        <!-- BEGIN: ACCORDION DEMO -->
        <div class="portlet light">
            <div class="portlet-title">
                <div class="caption font-dark">
                    <span class="caption-subject bold uppercase">新建调查</span>
                </div>
                <div class="tools">
                    <a href="" class="collapse"> </a>
                    <a href="" class="fullscreen"> </a>
                </div>
            </div>

            <div class="portlet-body" ng-controller="HighLevelToggle">
                <div class="col-md-12 col-sm-12 col-xs-12">
                    <div class="col-md-4 col-sm-12 col-xs-12 searchDatePicker">
                        <input type="text" id="searchDateRange" class="form-control">
                        <i class="fa fa-calendar"></i>
                    </div>
                    <div class="col-md-2 col-sm-12 col-xs-12" ng-dropdown-multiselect
                         options="selectByGroupData"
                         selected-model="selectByGroupModel"
                         extra-settings="selectByGroupSettings"
                         group-by="gender"
                         translation-texts="selectByGroupTexts">
                    </div>
                    <div class="col-md-1 col-sm-12 col-xs-12" style="margin-right: 15px;">
                        <button class="btn" style="width:100px; border:1px solid #cccccc;" ng-click="toggle()">高级
                        </button>
                    </div>
                    <div class="col-md-12 col-sm-12 col-xs-12 high-level" ng-show="myHide">
                        <div class="col-xs-12 condition" ng-controller="NewConditionController">
                            <div class="col-xs-12 search-condition" ng-repeat="id in conditions">
                                <div class="col-xs-2">
                                    <select class="select form-control"
                                            ng-model="id.value" ng-init="id.value = conditionName[0]"
                                            ng-options="x for x in conditionName" ng-change="change(id)">
                                    </select>
                                </div>
                                <div class="col-xs-2" ng-show="id.class1">
                                    <select class="select form-control" ng-model="id.include"
                                            ng-options="x for x in include" ng-init="id.include = include[0]">
                                    </select>
                                </div>
                                <div class="col-xs-2" ng-show="id.class2">
                                    <select class="select form-control" ng-model="id.equal"
                                            ng-options="x for x in equal" ng-init="id.equal = equal[0]">
                                    </select>
                                </div>
                                <div class="col-xs-3" ng-hide="id.class3">
                                    <input type="text" ng-model="id.input"
                                           class="search-input form-control ng-pristine ng-valid ng-touched">
                                </div>
                                <div class="col-xs-2" ng-show="id.class3">
                                    <select class="select form-control"
                                            ng-model="id.father"
                                            ng-init="id.father"
                                            ng-change="protocolInit(id)"
                                            ng-options="x for x in protocolFathers"></select>
                                </div>
                                <div class="col-xs-2" ng-show="id.class3">
                                    <select class="select form-control"
                                            ng-model="id.child" ng-init="id.child"
                                            ng-options="y for y in protocolChildren[id.father]">
                                    </select>
                                </div>
                                <button ng-show="closeable" type="button" class="close"
                                        ng-click="closeCondition($index)">
                                    <span aria-hidden="true">×</span>
                                    <span class="sr-only">关闭</span>
                                </button>
                            </div>
                            <div class="col-xs-2">
                                <button class="add-condition" ng-disabled="maxCondition" ng-click="addCondition()">
                                    +增加条件
                                </button>
                            </div>

                        </div>
                    </div>

                    <div class="col-md-4 col-sm-12 col-xs-12" ng-hide="myHide">
                        <button class="btn" ng-click="search()"
                                style="width: 100px; background-color:#0076e1; color: #ffffff; padding-right: 32px;">
                            <img src="./icon/search.png" style="margin: 0 4px 1px 0;">搜索
                        </button>
                        <button class="btn" style="width:100px; border:1px solid #cccccc">
                            <img src="./icon/save.png" style="margin: 0 4px 1px 0">保存规则
                        </button>
                    </div>
                    <div class="col-md-6 col-sm-12 col-xs-12" ng-show="myHide">
                        <button class="btn" ng-click="search()"
                                style="width: 100px; background-color:#0076e1; color: #ffffff; padding-right: 32px">
                            <img src="./icon/search.png" style="margin: 0 4px 1px 0;">搜索
                        </button>
                        <button class="btn" style="width:100px; border:1px solid #cccccc">
                            <img src="./icon/save.png" style="margin: 0 4px 1px 0">保存规则
                        </button>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12 col-sm-12 col-xs-12">
                        <div class="portlet light">
                            <div class="portlet-title">
                                <div class="caption font-dark col-md-6 col-sm-6 col-xs-12">
                                    <span class="caption-subject bold uppercase">调查结果</span>
                                </div>
                                <div class="col-md-6 col-sm-6 col-xs-12">
                                    <button class="btn dark btn-outline pull-right" id="exportResult">导出结果</button>
                                </div>
                            </div>
                            <div class="portlet-body">
                                <table class="table table-striped table-bordered table-hover" width="100%"
                                       id="search-result">
                                    <thead>
                                    <tr>
                                        <th width="3%"></th>
                                        <th width="17%">时间戳</th>
                                        <th width="15%">探针名</th>
                                        <th width="15%">进程用户名</th>
                                        <th width="10%">进程ID</th>
                                        <th width="25%">进程映像路径</th>
                                        <th width="15%">事件类型</th>
                                    </tr>
                                    </thead>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    ComponentsSelect2.init();
    ComponentsBootstrapSelect.init();
    UITree.init();
    //TableDatatablesResponsive.init();
</script>
<!-- BEGIN MAIN JS -->
<script>
    var dtable;
    var startTime = moment().startOf('day').format('X');
    var endTime = moment().format('X');
    $('#exportResult').hide();

    $('.searchDatePicker i').click(function () {
        $(this).parent().find('input').click();
    });

    $('#searchDateRange').daterangepicker({
        "timePicker": true,
        "timePicker24Hour": true,
        "maxDate": moment(),
        "ranges": {
            "今天": [moment().startOf('day'), moment()],
//            "昨天": [moment().subtract('days', 1).startOf('day'), moment().subtract('days', 1).endOf('day')],
//            "过去7天": [moment().subtract('days', 6), moment()],
            "本周": [moment().startOf('week'), moment()],
//            "过去30天": [moment().subtract('days', 29), moment()],
            "本月": [moment().startOf('month'), moment()]
        },
        "locale": {
            "format": "YYYY/MM/DD HH:mm",
            "separator": " 至 ",
            "applyLabel": "应用",
            "cancelLabel": "取消",
            "fromLabel": "从",
            "toLabel": "至",
            "customRangeLabel": "自定义",
            "weekLabel": "周",
            "daysOfWeek": [
                "日",
                "一",
                "二",
                "三",
                "四",
                "五",
                "六"
            ],
            "monthNames": [
                "一月",
                "二月",
                "三月",
                "四月",
                "五月",
                "六月",
                "七月",
                "八月",
                "九月",
                "十月",
                "十一月",
                "十二月"
            ],
            "firstDay": 1
        },
        "startDate": moment().startOf('day'),
        "endDate": moment()
    }, function (start, end, label) {
//        var utcOffset = Date.parse('1970-01-01 00:00:00');
//        console.log(utcOffset);
        startTime = start / 1000;
        endTime = Math.ceil(end / 1000);
        console.log("New date range selected: " + startTime + ' to ' + endTime + ' (predefined range: ' + label + ')');
        console.log(moment().minute());
    });


    function HighLevelToggle($scope) {
        $scope.myHide = false;
        $scope.toggle = function () {
            $scope.myHide = !$scope.myHide;
        };
        $scope.conditions = [
            {
                key: 1,
                value: "test",
                class1: true,
                class2: false,
                class3: false,
                input: "",
                father: "分类一",
                child: "HTTP",
                include: "包含",
                equal: "等于"
            }
        ];
        $scope.selectByGroupModel = [];
        $scope.selectByGroupData = [
            {id: 1, label: "David", gender: 'M'},
            {id: 2, label: "Jhon", gender: 'M'},
            {id: 3, label: "Lisa", gender: 'F'},
            {id: 4, label: "Nicole", gender: 'F'},
            {id: 5, label: "Danny1", gender: 'M'},
            {id: 6, label: "Danny2", gender: 'M'},
            {id: 7, label: "Danny3", gender: 'M'},
            {id: 8, label: "Danny4", gender: 'M'},
            {id: 9, label: "Danny5", gender: 'M'},
            {id: 10, label: "Danny6", gender: 'M'},
            {id: 11, label: "Danny7", gender: 'M'},
            {id: 12, label: "Danny8", gender: 'M'},
            {id: 13, label: "Danny9", gender: 'M'},
            {id: 14, label: "Danny10", gender: 'M'},
            {id: 15, label: "Danny11", gender: 'M'},
            {id: 16, label: "Danny12", gender: 'M'},
            {id: 17, label: "Danny13", gender: 'M'},
            {id: 18, label: "Danny14", gender: 'M'},
            {id: 19, label: "Danny15", gender: 'M'},
            {id: 20, label: "Danny16", gender: 'M'},
            {id: 21, label: "Danny17", gender: 'M'},
            {id: 22, label: "Danny18", gender: 'M'},
            {id: 23, label: "Danny19", gender: 'M'},
            {id: 24, label: "Danny20", gender: 'M'},
            {id: 25, label: "Danny21", gender: 'M'},
            {id: 26, label: "Danny22", gender: 'M'},
            {id: 27, label: "Danny23", gender: 'M'},
            {id: 28, label: "Danny24", gender: 'M'},
            {id: 29, label: "Danny25", gender: 'M'},
            {id: 30, label: "Danny26", gender: 'M'},
            {id: 31, label: "Danny27", gender: 'M'},
            {id: 32, label: "Danny28", gender: 'M'},
            {id: 33, label: "Danny29", gender: 'M'},
            {id: 34, label: "Danny30", gender: 'M'},
            {id: 35, label: "Danny31", gender: 'M'},
            {id: 36, label: "Danny32", gender: 'M'},
            {id: 37, label: "Danny33", gender: 'M'},
            {id: 38, label: "Danny34", gender: 'M'},
            {id: 39, label: "Danny35", gender: 'M'},
            {id: 40, label: "Danny36", gender: 'M'},
            {id: 41, label: "Danny37", gender: 'M'},
            {id: 42, label: "Danny38", gender: 'M'},
            {id: 43, label: "Danny39", gender: 'M'},
            {id: 44, label: "Danny40", gender: 'M'},
            {id: 45, label: "Unknown", gender: 'O'}];

        $scope.selectByGroupSettings = {
            selectByGroups: ['F', 'M'],
            groupByTextProvider: function (groupValue) {
                switch (groupValue) {
                    case 'M':
                        return 'Male';
                    case 'F':
                        return 'Female';
                    case 'O':
                        return 'Other';
                }
            },
            scrollableHeight: '400px',
            scrollable: true,
            enableSearch: true
        };

        $scope.selectByGroupTexts = {
            buttonDefaultText: "所有探针设备...",
            selectGroup: '选择所有:',
            allSelectedText: '全部',
            searchPlaceholder: '检索...',
            checkAll: '选择所有',
            uncheckAll: '取消所有选择',
            selectionCount: '被选中'
        };

        $scope.search = function () {
            $scope.filter_condition = {
//                "process_user": {
//                    "include": [],
//                    "exclude": []
//                },
//                "pid": {
//                    "include": [],
//                    "exclude": []
//                },
//                "process_name": {
//                    "include": [],
//                    "exclude": []
//                },
//                "ip": {
//                    "include": [],
//                    "exclude": []
//                },
//                "net_protocol": {
//                    "include": [],
//                    "exclude": []
//                },
//                "file_name": {
//                    "include": [],
//                    "exclude": []
//                },
//                "url": {
//                    "include": [],
//                    "exclude": []
//                }
            };
            $scope.search_condition = [];
            for (var i = 0; i < $scope.conditions.length; i++) {
                if ($scope.conditions[i].value == "网络协议名") {
                    $scope.search_condition.push({key: $scope.conditions[i].value, input: $scope.conditions[i].child});
                }
                else {
                    $scope.search_condition.push({key: $scope.conditions[i].value, input: $scope.conditions[i].input});
                }
                var input_list;
                switch ($scope.conditions[i].value) {
                    case "进程用户名":
                        if ($scope.conditions[i].input == "") {
                            break
                        }
                        $scope.filter_condition["process_user"] = {};
                        input_list = $scope.conditions[i].input.split(',');
                        for(var a = 0; a < input_list.length; a++) {
                            if (input_list[a] == "") {
                                continue
                            }
                            if ($scope.conditions[i].include == "包含") {
                                if (!$scope.filter_condition["process_user"]["include"]) {
                                    $scope.filter_condition["process_user"]["include"] = [];
                                }
                                $scope.filter_condition["process_user"]["include"].push($.trim(input_list[a]));
                            }
                            else {
                                if (!$scope.filter_condition["process_user"]["exclude"]) {
                                    $scope.filter_condition["process_user"]["exclude"] = [];
                                }
                                $scope.filter_condition["process_user"]["exclude"].push($.trim(input_list[a]));
                            }
                        }
                        break;
                    case "进程ID":
                        if ($scope.conditions[i].input == "") {
                            break
                        }
                        $scope.filter_condition["pid"] = {};
                        input_list = $scope.conditions[i].input.split(',');
                        for(var b = 0; b < input_list.length; b++) {
                            if (input_list[b] == "") {
                                continue
                            }
                            if ($scope.conditions[i].equal == "等于") {
                                if (!$scope.filter_condition["pid"]["include"]) {
                                    $scope.filter_condition["pid"]["include"] = [];
                                }
                                $scope.filter_condition["pid"]["include"].push($.trim(input_list[b]));
                            }
                            else {
                                if (!$scope.filter_condition["pid"]["exclude"]) {
                                    $scope.filter_condition["pid"]["exclude"] = [];
                                }
                                $scope.filter_condition["pid"]["exclude"].push($.trim(input_list[b]));
                            }
                        }
                        break;
                    case "进程名":
                        if ($scope.conditions[i].input == "") {
                            break
                        }
                        $scope.filter_condition["process_name"] = {};
                        input_list = $scope.conditions[i].input.split(',');
                        for(var c = 0; c < input_list.length; c++) {
                            if (input_list[c] == "") {
                                continue
                            }
                            if ($scope.conditions[i].include == "包含") {
                                if (!$scope.filter_condition["process_name"]["include"]) {
                                    $scope.filter_condition["process_name"]["include"] = [];
                                }
                                $scope.filter_condition["process_name"]["include"].push($.trim(input_list[c]));
                            }
                            else {
                                if (!$scope.filter_condition["process_name"]["exclude"]) {
                                    $scope.filter_condition["process_name"]["exclude"] = [];
                                }
                                $scope.filter_condition["process_name"]["exclude"].push($.trim(input_list[c]));
                            }
                        }
                        break;
                    case "IP地址":
                        if ($scope.conditions[i].input == "") {
                            break
                        }
                        $scope.filter_condition["ip"] = {};
                        input_list = $scope.conditions[i].input.split(',');
                        for(var d = 0; d < input_list.length; d++) {
                            if (input_list[d] == "") {
                                continue
                            }
                            if ($scope.conditions[i].equal == "等于") {
                                if (!$scope.filter_condition["ip"]["include"]) {
                                    $scope.filter_condition["ip"]["include"] = [];
                                }
                                $scope.filter_condition["ip"]["include"].push($.trim(input_list[d]));
                            }
                            else {
                                if (!$scope.filter_condition["ip"]["exclude"]) {
                                    $scope.filter_condition["ip"]["exclude"] = [];
                                }
                                $scope.filter_condition["ip"]["exclude"].push($.trim(input_list[d]));
                            }
                        }
                        break;
                    case "网络协议名":
                        $scope.filter_condition["net_protocol"] = {};
                        $scope.filter_condition["net_protocol"]["include"] = [];
                        $scope.filter_condition["net_protocol"]["include"].push($scope.conditions[i].child);
                        break;
                    case "文件名":
                        if ($scope.conditions[i].input == "") {
                            break
                        }
                        $scope.filter_condition["file_name"] = {};
                        input_list = $scope.conditions[i].input.split(',');
                        for(var f = 0; f < input_list.length; f++) {
                            if (input_list[f] == "") {
                                continue
                            }
                            if ($scope.conditions[i].include == "包含") {
                                if (!$scope.filter_condition["file_name"]["include"]) {
                                    $scope.filter_condition["file_name"]["include"] = [];
                                }
                                $scope.filter_condition["file_name"]["include"].push($.trim(input_list[f]));
                            }
                            else {
                                if (!$scope.filter_condition["file_name"]["exclude"]) {
                                    $scope.filter_condition["file_name"]["exclude"] = [];
                                }
                                $scope.filter_condition["file_name"]["exclude"].push($.trim(input_list[f]));
                            }
                        }
                        break;
                    case "Url":
                        if ($scope.conditions[i].input == "") {
                            break
                        }
                        $scope.filter_condition["url"] = {};
                        input_list = $scope.conditions[i].input.split(',');
                        for(var g = 0; g < input_list.length; g++) {
                            if (input_list[g] == "") {
                                continue
                            }
                            if ($scope.conditions[i].include == "包含") {
                                if (!$scope.filter_condition["url"]["include"]) {
                                    $scope.filter_condition["url"]["include"] = [];
                                }
                                $scope.filter_condition["url"]["include"].push($.trim(input_list[g]));
                            }
                            else {
                                if (!$scope.filter_condition["url"]["exclude"]) {
                                    $scope.filter_condition["url"]["exclude"] = [];
                                }
                                $scope.filter_condition["url"]["exclude"].push($.trim(input_list[g]));
                            }
                        }
                        break;
                }
            }
            SearchResultCtrl($scope.selectByGroupModel, $scope.filter_condition, $scope.search_condition);
            $scope.myHide = false;
        }
    }

    var getValue = function (item) {
        return item.split("=")[1];
    };

    var highlightInclude = function (str, keyword, key) {
        for (var i = 0; i < keyword.length; i++) {
            if (str.indexOf(keyword[i]) < 0) {
                continue;
            }
            else {
                list = str.split(keyword[i]);
                str = list[0];
                for (var j = 1; j < list.length; j++) {
                    str += '<mark-' + key + '>';
                    str += keyword[i];
                    str += '</mark-' + key + '>';
                    str += list[j];
                }
            }
        }
        return str;
    };

    var highlightEqual = function (str, keyword, key) {
        for (var i = 0; i < keyword.length; i++) {
            if (str.indexOf(keyword[i]) < 0) {
                continue;
            }
            else {
                list = str.split(keyword[i]);
                str = list[0];
                for (var j = 1; j < list.length; j++) {
                    str += '<mark-' + key + '>';
                    str += keyword[i];
                    str += '</mark-' + key + '>';
                    str += list[j];
                }
            }
        }
        return str;
    };

    var highlightStr = function (str, condition) {
        //TODO: pid & ip 等于，not 包含！
        var keyValue = str.split('=');
        var result = keyValue[1];
        for (var i = 0; i < condition.length; i++) {
            if (condition[i].input == "") {
                result = keyValue[1];
            }
            else {
                var keyword = condition[i].input.split(',');
                if (keyword.length > 0) {
                    switch (condition[i].key) {
                        case "进程用户名":
                            if (keyValue[0] == "clf_user") {
                                result = highlightInclude(result, keyword, key = "user");
                            }
                            break;
                        case "进程ID":
                            if (keyValue[0] == "clf_pid") {
                                result = highlightEqual(result, keyword, key = "pid");
                            }
                            break;
                        case "进程名":
                            if (keyValue[0] == "clf_processName") {
                                result = highlightInclude(result, keyword, key = "pname");
                            }
                            break;
                        case "IP地址":
                            if (keyValue[0] == "clf_src_ip" || keyValue[0] == "clf_dst_ip") {
                                result = highlightEqual(result, keyword, key = "ip");
                            }
                            break;
                        case "网络协议名":
                            if (keyValue[0] == "CLF_NetProtocol") {
                                result = highlightEqual(result, keyword, key = "protocol");
                            }
                            break;
                        case "Url":
                            if (keyValue[0] == "CLF_Url") {
                                result = highlightInclude(result, keyword, key = "url");
                            }
                            break;
                        case "文件名":
                            if (keyValue[0] == "CLF_File") {
                                result = highlightInclude(result, keyword, key = "fname");
                            }
                            break;
                    }
                }
            }
        }
        return result;
    };

    var formatData = function (item, condition) {
        var result = "";
        for (var i = 0; i < item.length; i++) {
            result += ' | ';
            result += '<b>';
            result += item[i].split("=")[0];
            result += '</b>';
            result += ':';
            result += highlightStr(item[i], condition);
        }
        return result.substring(2);
    };

    var format = function (obj) {
        return '<tr>' + '<td>' + obj + '</td>' + '</tr>';
    };

    var timeStamp2String = function (time) {
        var datetime = new Date();
        datetime.setTime(time);
        var year = datetime.getFullYear();
        var month = datetime.getMonth() + 1;
        var date = datetime.getDate();
        var hour = datetime.getHours();
        var minute = datetime.getMinutes();
        var second = datetime.getSeconds();
        var mseconds = datetime.getMilliseconds();
        return year + "-" + month + "-" + date + " " + hour + ":" + minute + ":" + second;
    };

    var SearchResultCtrl = function (device, filter_condition, search_condition) {
        if (device.length == 0) {
            var device_id = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45];
        }
        else {
            var device_id = [];
            for (var i = 0; i < device.length; i++) {
                device_id.push(device[i].id)
            }
        }

        var postJson = {
            "begin_time": startTime,
            "end_time": endTime,
            "device_id": ["abc123"],
//            "device_id": [0],
            "event_type": 0,
            "filter_condition": filter_condition
//            "filter_condition": {
//                "process_user": {},
//                "pid": {
//                    "include": [864]
//                }
//
//            }
        };
        $.ajax({
            type: "POST",
            dataType: "json",
            url: 'http://10.21.140.129:8080/logquery',
            data: JSON.stringify(postJson),
            success: function (data) {
                var results = [];
                if (data == "") {
                    results = [];
                }
                else {
                    for (var k = 0; k < data.data.length; k++) {
                        var rows = data.data[k];
                        for (var i = 0; i < rows.rows.length; i++) {
                            var list = rows.rows[i].split('\t');
                            results.push({
                                timestamp: timeStamp2String(getValue(list[0])),
                                deviceName: getValue(list[1]),
                                processUsername: getValue(list[2]),
                                processId: getValue(list[3]),
                                processPath: getValue(list[4]),
                                eventType: getValue(list[5]),
                                content: formatData(list.slice(12), search_condition)
                            })
                        }
                    }
                }

                var config = {
                    data: results,
                    columns: [
                        {
                            "class": 'details-control',
                            "orderable": false,
                            "data": null,
                            "defaultContent": ''
                        },
                        {data: "timestamp"},
                        {data: "deviceName"},
                        {data: "processUsername"},
                        {data: "processId"},
                        {data: "processPath"},
                        {data: "eventType"}],
                    order: [],
                    sPaginationType: "full_numbers",
                    language: {
                        aria: {
                            sortAscending: ": activate to sort column ascending",
                            sortDescending: ": activate to sort column descending"
                        },
                        emptyTable: "无匹配的数据可显示",
                        info: "显示 _TOTAL_ 条目中的第 _START_ 至 _END_ 条",
                        infoEmpty: "没有匹配的条目",
                        infoFiltered: "(过滤出 filtered1 条目，总计 _MAX_ 条目)",
                        lengthMenu: "_MENU_ 项",
                        search: "搜索:",
                        zeroRecords: "无匹配的数据可显示",
                        paginate: {
                            last: "末页",
                            next: "下一页",
                            previous: "上一页",
                            first: "首页"
                        }
                    },
                    lengthMenu: [
                        [20, 50, 100],
                        ["20条", "50条", "100条"] // change per page values here
                    ],
                    "dom": "<'row' <'col-md-12'B>><'row'<'col-md-2 col-sm-12'l><'col-md-3 col-sm-12'f><'col-md-7 col-sm-12'p>r><t><'row'<'col-md-4 col-sm-12'i><'col-md-8 col-sm-12'p>>"
                };

                if (dtable != null) {
                    dtable.fnClearTable();
                    dtable.fnDestroy();
                    $("tbody").remove();
                }

                dtable = $('#search-result').dataTable(config);
                $("tbody").on('click', 'td.details-control', function () {
                    var tr = $(this).closest('tr');
                    var row = dtable.api().row(tr);
                    if (row.child.isShown()) {
                        // This row is already open - close it
                        row.child.hide();
                        tr.removeClass('shown');
                    }
                    else {
                        row.child(format((row.data().content))).show();
                        tr.addClass('shown');
                    }
                });

                if (dtable == null) {
                    $('#exportResult').hide();
                }
                else {
                    $('#exportResult').show();
                }
            }
        });

//        $.getJSON('./views/data1.js', function (data) {
//            var results = [];
//            for (var k = 0; k < data.data.length; k++) {
//                var rows = data.data[k];
//                for (var i = 0; i < rows.rows.length; i++) {
//                    var list = rows.rows[i].split('\t');
//                    results.push({
//                        timestamp: timeStamp2String(getValue(list[0])),
//                        deviceName: getValue(list[1]),
//                        processUsername: getValue(list[2]),
//                        processId: getValue(list[3]),
//                        processPath: getValue(list[4]),
//                        eventType: getValue(list[5]),
//                        content: formatData(list.slice(12), search_condition)
//                    })
//                }
//            }
//
//            var config = {
//                data: results,
//                columns: [
//                    {
//                        "class": 'details-control',
//                        "orderable": false,
//                        "data": null,
//                        "defaultContent": ''
//                    },
//                    {data: "timestamp"},
//                    {data: "deviceName"},
//                    {data: "processUsername"},
//                    {data: "processId"},
//                    {data: "processPath"},
//                    {data: "eventType"}],
//                order: [],
//                sPaginationType: "full_numbers",
//                language: {
//                    aria: {
//                        sortAscending: ": activate to sort column ascending",
//                        sortDescending: ": activate to sort column descending"
//                    },
//                    emptyTable: "无匹配的数据可显示",
//                    info: "显示 _TOTAL_ 条目中的第 _START_ 至 _END_ 条",
//                    infoEmpty: "没有匹配的条目",
//                    infoFiltered: "(过滤出 filtered1 条目，总计 _MAX_ 条目)",
//                    lengthMenu: "_MENU_ 项",
//                    search: "搜索:",
//                    zeroRecords: "无匹配的数据可显示",
//                    paginate:{
//                        last: "末页",
//                        next: "下一页",
//                        previous: "上一页",
//                        first: "首页"
//                    }
//                },
//                lengthMenu: [
//                    [20, 50, 100],
//                    ["20条", "50条", "100条"] // change per page values here
//                ],
//                "dom": "<'row' <'col-md-12'B>><'row'<'col-md-2 col-sm-12'l><'col-md-3 col-sm-12'f><'col-md-7 col-sm-12'p>r><t><'row'<'col-md-4 col-sm-12'i><'col-md-8 col-sm-12'p>>"
//            };
//
//            if (dtable != null) {
//                dtable.fnClearTable();
//                dtable.fnDestroy();
//                $("tbody").remove();
//            }
//
//            dtable = $('#search-result').dataTable(config);
//            $("tbody").on('click', 'td.details-control', function () {
//                var tr = $(this).closest('tr');
//                var row = dtable.api().row(tr);
//                if (row.child.isShown()) {
//                    // This row is already open - close it
//                    row.child.hide();
//                    tr.removeClass('shown');
//                }
//                else {
//                    row.child(format((row.data().content))).show();
//                    tr.addClass('shown');
//                }
//            });
//
//            if (dtable == null) {
//                $('#exportResult').hide();
//            }
//            else {
//                $('#exportResult').show();
//            }
//        })
    };

        function NewConditionController($scope) {
            $scope.conditionName = ["进程用户名", "进程ID", "进程名", "IP地址", "网络协议名", "Url", "文件名"];
            $scope.protocolFathers = ["分类一", "分类二"];
            $scope.protocolChildren = {
                "分类一": ["HTTP", "HTTPS"],
                "分类二": ["FTP", "SSH"]
            };
            $scope.include = ["包含", "不包含"];
            $scope.equal = ["等于", "不等于"];
            $scope.change = function (item) {
                if (item.value == "网络协议名") {
                    item.class1 = false;
                    item.class2 = false;
                    item.class3 = true;
                }
                else if (item.value == "进程ID" || item.value == "IP地址") {
                    item.class1 = false;
                    item.class2 = true;
                    item.class3 = false;
                }
                else {
                    item.class1 = true;
                    item.class2 = false;
                    item.class3 = false;
                }
            };

            $scope.protocolInit = function (item) {
                item.child = $scope.protocolChildren[item.father][0];
            };
            $scope.index = 2;
            $scope.maxCondition = false;
            $scope.closeable = false;
            $scope.addCondition = function () {
                $scope.conditions.push(
                    {
                        key: $scope.index,
                        value: "test",
                        class1: true,
                        class2: false,
                        class3: false,
                        input: "",
                        father: "分类一",
                        child: "HTTP",
                        include: "包含",
                        equal: "等于"
                    }
                );
                $scope.index += 1;
                $scope.closeable = true;
                if ($scope.conditions.length == 7) {
                    $scope.maxCondition = true;
                }
            };
            $scope.closeCondition = function (index) {
                $scope.conditions.splice(index, 1);
                if ($scope.conditions.length == 1) {
                    $scope.closeable = false;
                }
                $scope.maxCondition = false;
            };
        }

</script>
<!-- END MAIN JS -->